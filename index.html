<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Global Volume + Active Audio Demo</title>
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 20px; }
  .controls { display:flex; gap:12px; align-items:center; margin-bottom:16px; }
  .player { margin:12px 0; }
  .visually-hidden { position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden; }
  .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); }
  .modal .sheet { background:#fff; padding:20px; border-radius:8px; width:90%; max-width:480px; }
  button { cursor:pointer; }
</style>
</head>
<body>

<h3>Global volume with active-window audio</h3>

<div class="controls" role="region" aria-label="Global audio controls">
  <label for="volumeRange">Volume</label>
  <input id="volumeRange" type="range" min="0" max="100" value="50" aria-label="Volume" />
  <button id="muteBtn" aria-pressed="false" aria-label="Mute toggle">ðŸ”Š</button>
  <button id="openModalBtn" aria-haspopup="dialog">Open modal player</button>
</div>

<div class="player" id="player1">
  <strong>Player 1</strong>
  <div>
    <button class="playBtn" data-target="audio1">Play</button>
    <button class="pauseBtn" data-target="audio1">Pause</button>
  </div>
  <audio id="audio1" src="https://www.w3schools.com/html/horse.mp3" preload="none"></audio>
</div>

<div class="player" id="player2">
  <strong>Player 2</strong>
  <div>
    <button class="playBtn" data-target="audio2">Play</button>
    <button class="pauseBtn" data-target="audio2">Pause</button>
  </div>
  <audio id="audio2" src="https://www.w3schools.com/html/horse.ogg" preload="none"></audio>
</div>

<!-- Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="sheet">
    <h4>Modal Player</h4>
    <div>
      <button id="modalPlayBtn">Play</button>
      <button id="modalPauseBtn">Pause</button>
      <button id="closeModalBtn">Close</button>
    </div>
    <audio id="modalAudio" src="https://www.w3schools.com/html/horse.mp3" preload="none"></audio>
  </div>
</div>

<script>
/* Single-copy paste script implementing:
   - global volume slider (default 50%)
   - activeAudio concept: only active audio is audible; others paused and muted
   - persistence via localStorage
   - mute toggle and modal sync
*/

const AUDIO_KEY = 'siteVolume';
let globalVolume = (localStorage.getItem(AUDIO_KEY) !== null)
  ? Number(localStorage.getItem(AUDIO_KEY)) / 100
  : 0.5;
let activeAudio = null;
const volumeRange = document.getElementById('volumeRange');
const muteBtn = document.getElementById('muteBtn');
const openModalBtn = document.getElementById('openModalBtn');
const modal = document.getElementById('modal');
const closeModalBtn = document.getElementById('closeModalBtn');
const modalAudio = document.getElementById('modalAudio');

// Initialize UI
volumeRange.value = Math.round(globalVolume * 100);
updateMuteButton();

// Apply volume to all audio elements
function applyVolumeToAll() {
  document.querySelectorAll('audio, video').forEach(el => {
    el.volume = globalVolume;
  });
}
applyVolumeToAll();

// Set global volume percent (0-100)
function setGlobalVolumePercent(percent) {
  globalVolume = Math.max(0, Math.min(100, Number(percent))) / 100;
  localStorage.setItem(AUDIO_KEY, Math.round(globalVolume * 100));
  volumeRange.value = Math.round(globalVolume * 100);
  applyVolumeToAll();
  // If there's an active audio, ensure it's unmuted; others remain muted/paused
  if (activeAudio) {
    activeAudio.muted = globalVolume === 0;
  }
  updateMuteButton();
}

// Update mute button aria state and icon
function updateMuteButton() {
  const pressed = globalVolume === 0;
  muteBtn.setAttribute('aria-pressed', pressed ? 'true' : 'false');
  muteBtn.textContent = pressed ? 'ðŸ”ˆ' : 'ðŸ”Š';
}

// Make an element the active audio
function setActiveAudio(el) {
  if (!el || !(el instanceof HTMLMediaElement)) return;
  if (activeAudio === el) return;
  // Pause and mute previous active
  if (activeAudio && !activeAudio.paused) {
    activeAudio.pause();
  }
  document.querySelectorAll('audio, video').forEach(a => {
    if (a !== el) {
      try { a.pause(); } catch(e) {}
      a.muted = true;
    }
  });
  activeAudio = el;
  activeAudio.volume = globalVolume;
  activeAudio.muted = globalVolume === 0;
}

// Wire play/pause buttons for page players
document.querySelectorAll('.playBtn').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const id = btn.dataset.target;
    const audio = document.getElementById(id);
    if (!audio) return;
    setActiveAudio(audio);
    try {
      await audio.play();
    } catch (err) {
      // Play may be blocked if not a user gesture; this is a user gesture so usually fine
      console.warn('Play failed', err);
    }
  });
});
document.querySelectorAll('.pauseBtn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const id = btn.dataset.target;
    const audio = document.getElementById(id);
    if (!audio) return;
    audio.pause();
    if (activeAudio === audio) activeAudio = null;
  });
});

// Modal open/close and modal player wiring
openModalBtn.addEventListener('click', () => {
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden', 'false');
  // Ensure modal audio uses current global volume and becomes active when played
  modalAudio.volume = globalVolume;
  modalAudio.muted = globalVolume === 0;
  // Optionally auto-focus a control
  document.getElementById('modalPlayBtn').focus();
});
closeModalBtn.addEventListener('click', () => {
  // Pause modal audio and close
  try { modalAudio.pause(); } catch {}
  if (activeAudio === modalAudio) activeAudio = null;
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden', 'true');
});

// Modal play/pause
document.getElementById('modalPlayBtn').addEventListener('click', async () => {
  setActiveAudio(modalAudio);
  try {
    await modalAudio.play();
  } catch (err) {
    console.warn('Modal play blocked', err);
  }
});
document.getElementById('modalPauseBtn').addEventListener('click', () => {
  modalAudio.pause();
  if (activeAudio === modalAudio) activeAudio = null;
});

// Volume slider input
volumeRange.addEventListener('input', (e) => {
  setGlobalVolumePercent(e.target.value);
});

// Mute toggle
muteBtn.addEventListener('click', () => {
  if (globalVolume === 0) {
    // restore to 50% when unmuting (sensible default)
    setGlobalVolumePercent(50);
  } else {
    setGlobalVolumePercent(0);
  }
});

// When any audio element starts playing (e.g., user uses native controls), make it active
document.querySelectorAll('audio').forEach(a => {
  a.addEventListener('play', () => {
    setActiveAudio(a);
    // Pause others
    document.querySelectorAll('audio').forEach(other => {
      if (other !== a) {
        try { other.pause(); } catch {}
        other.muted = true;
      }
    });
  });
  a.addEventListener('ended', () => {
    if (activeAudio === a) activeAudio = null;
  });
});

// Visibility handling: pause active audio when tab hidden (optional)
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    if (activeAudio && !activeAudio.paused) activeAudio.pause();
  }
});

// Initialize volumes on load (ensures any audio added later inherits)
setGlobalVolumePercent(Math.round(globalVolume * 100));
</script>
</body>
</html>
