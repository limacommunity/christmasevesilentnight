<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360 Cinematic Sync</title>
    <style>
        :root { --vimeo-blue: #00adef; --bg-dark: #0f0f0f; }
        body {
            background-color: var(--bg-dark); color: white;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; min-height: 100vh; margin: 0; font-family: sans-serif;
        }

        #player-container {
            width: 85%; max-width: 850px; aspect-ratio: 16 / 9;
            background: #000; border-radius: 8px; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        #slave-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .modal-content { width: 90%; max-width: 1100px; position: relative; }
        .close-btn {
            position: absolute; top: -50px; right: 0;
            background: #ff3b30; color: white; border: none;
            padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;
        }

        .video-ratio { position: relative; padding-bottom: 56.25%; height: 0; background: #000; }
        .video-ratio iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

        .controls { margin-top: 30px; display: flex; gap: 15px; }
        button {
            padding: 16px 32px; font-size: 14px; font-weight: bold;
            cursor: pointer; border: none; border-radius: 50px;
            text-transform: uppercase; transition: 0.2s;
        }
        #masterBtn { background: var(--vimeo-blue); color: white; min-width: 180px; }
        #view360Btn { background: white; color: black; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
    </style>
</head>
<body>

    <div id="player-container"></div>

    <div id="slave-modal">
        <div class="modal-content">
            <button class="close-btn" id="closeBtn">CLOSE 360 VIEW</button>
            <div class="video-ratio" id="slave-holder"></div>
        </div>
    </div>

    <div class="controls">
        <button id="masterBtn" disabled>Loading...</button>
        <button id="view360Btn" disabled>Full 360 View</button>
    </div>

    <script src="https://player.vimeo.com/api/player.js"></script>
    <script>
        // Master initialized normally
        const master = new Vimeo.Player('player-container', { id: 1148671786, responsive: true });
        
        // Slave initialized inside the modal holder immediately, muted
        const slave = new Vimeo.Player('slave-holder', { id: 1141863363, responsive: true, muted: true });
        
        const masterBtn = document.getElementById('masterBtn');
        const view360Btn = document.getElementById('view360Btn');
        const slaveModal = document.getElementById('slave-modal');

        let isPlaying = false;
        let lastSyncTime = 0;

        Promise.all([master.ready(), slave.ready()]).then(() => {
            masterBtn.disabled = false;
            view360Btn.disabled = false;
            masterBtn.innerText = "Start Experience";
        });

        masterBtn.onclick = function() {
            master.getPaused().then(paused => {
                if (paused) {
                    // Start Master first. Only start slave if master succeeds.
                    master.play().then(() => {
                        slave.play();
                        isPlaying = true;
                    }).catch(() => {
                        // Fallback: Mute and play if browser blocks sound
                        master.setMuted(true);
                        master.play();
                        slave.play();
                    });
                } else {
                    master.pause();
                    slave.pause();
                }
            });
        };

        // Throttled Sync: Only checks every 1000ms (1 second) to prevent crashing
        master.on('timeupdate', (data) => {
            const now = Date.now();
            if (now - lastSyncTime > 1000) { 
                slave.getCurrentTime().then(sTime => {
                    if (Math.abs(data.seconds - sTime) > 0.8) {
                        slave.setCurrentTime(data.seconds);
                    }
                });
                lastSyncTime = now;
            }
        });

        // Modal Logic
        view360Btn.onclick = function() {
            master.getCurrentTime().then(t => {
                slave.setCurrentTime(t);
                slaveModal.style.display = 'flex';
            });
        };

        document.getElementById('closeBtn').onclick = function() {
            slaveModal.style.display = 'none';
        };

        // UI Listeners
        master.on('play', () => { masterBtn.innerText = "Pause Experience"; });
        master.on('pause', () => { masterBtn.innerText = "Resume Experience"; });
    </script>
</body>
</html>